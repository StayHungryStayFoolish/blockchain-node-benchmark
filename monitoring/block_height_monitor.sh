#!/bin/bash

# =====================================================================
# Â§öÈìæÂå∫ÂùóÈ´òÂ∫¶ÁõëÊéßÊ®°Âùó
# Áî®‰∫éÁõëÊéßÊú¨Âú∞Âå∫ÂùóÈìæËäÇÁÇπ‰∏é‰∏ªÁΩë‰πãÈó¥ÁöÑÂå∫ÂùóÈ´òÂ∫¶Â∑ÆÂºÇ
# =====================================================================

# Âä†ËΩΩÈÖçÁΩÆÊñá‰ª∂
# ÂÆâÂÖ®Âä†ËΩΩÈÖçÁΩÆÊñá‰ª∂ÔºåÈÅøÂÖçreadonlyÂèòÈáèÂÜ≤Á™Å
if ! source "$(dirname "${BASH_SOURCE[0]}")/../config/config_loader.sh" 2>/dev/null; then
    echo "Ë≠¶Âëä: ÈÖçÁΩÆÊñá‰ª∂Âä†ËΩΩÂ§±Ë¥•Ôºå‰ΩøÁî®ÈªòËÆ§ÈÖçÁΩÆ"
    BLOCK_HEIGHT_MONITOR_RATE=${BLOCK_HEIGHT_MONITOR_RATE:-1}
    LOGS_DIR=${LOGS_DIR:-"/tmp/blockchain-node-benchmark/logs"}
fi

# ÂàùÂßãÂåñÂèòÈáè
MONITOR_PID=""
BLOCK_HEIGHT_DIFF_ALERT=false
BLOCK_HEIGHT_DIFF_START_TIME=""
BLOCK_HEIGHT_DIFF_END_TIME=""
BLOCK_HEIGHT_DIFF_EVENT_ID=""
BLOCK_HEIGHT_DIFF_EVENTS=()
DATA_LOSS_ALERT=false
DATA_LOSS_START_TIME=""
DATA_LOSS_END_TIME=""
DATA_LOSS_EVENTS=()

# Ê∏ÖÁêÜÂíåÈÄÄÂá∫ÂáΩÊï∞
cleanup_and_exit() {
    echo "Received termination signal, cleaning up block height monitor..."
    
    # Âà∑Êñ∞ÊâÄÊúâÁºìÂÜ≤
    if [[ -n "$BLOCK_HEIGHT_DATA_FILE" && -f "$BLOCK_HEIGHT_DATA_FILE" ]]; then
        sync "$BLOCK_HEIGHT_DATA_FILE" 2>/dev/null || true
        rm -f "${BLOCK_HEIGHT_DATA_FILE}.buffer" 2>/dev/null || true
    fi
    
    # Âà†Èô§PIDÊñá‰ª∂
    rm -f "${TMP_DIR}/block_height_monitor.pid" 2>/dev/null || true
    
    # Ê∏ÖÁêÜÂÖ±‰∫´ÂÜÖÂ≠òÁºìÂ≠ò - Âè™Ê∏ÖÁêÜblock_heightÁõ∏ÂÖ≥Êñá‰ª∂Ôºå‰øùÁïôQPSÁä∂ÊÄÅÊñá‰ª∂
    if [[ -n "$BASE_MEMORY_DIR" ]]; then
        # Âè™Ê∏ÖÁêÜblock_heightÁõ∏ÂÖ≥ÁöÑÁºìÂ≠òÊñá‰ª∂Ôºå‰øùÁïôÂÖ∂‰ªñËøõÁ®ãÁöÑÁä∂ÊÄÅÊñá‰ª∂
        rm -f "$MEMORY_SHARE_DIR"/block_height_monitor_cache.json 2>/dev/null || true
        rm -f "$BASE_MEMORY_DIR"/node_health_*.cache 2>/dev/null || true
    fi
    
    echo "Block height monitor cleanup completed"
    exit 0
}

# Ê≥®ÊÑèÔºö‰ø°Âè∑Â§ÑÁêÜÂ∞ÜÂú®ÂêéÂè∞ÁõëÊéßÊ®°Âºè‰∏ãËÆæÁΩÆÔºåËÄå‰∏çÊòØÂÖ®Â±ÄËÆæÁΩÆ
DATA_LOSS_COUNT=0
DATA_LOSS_PERIODS=0
DATA_LOSS_TOTAL_DURATION=0
BACKGROUND=false
VERBOSE=false

# Â∏ÆÂä©‰ø°ÊÅØ
show_help() {
    echo "Multi-Chain Block Height Monitor"
    echo "Usage: $0 [options]"
    echo ""
    echo "Options:"
    echo "  -h, --help                 Show this help message"
    echo "  -r, --rate RATE            Set monitoring rate (times per second, default: ${BLOCK_HEIGHT_MONITOR_RATE})"
    echo "  --diff BLOCKS              Set block height difference threshold (default: ${BLOCK_HEIGHT_DIFF_THRESHOLD})"
    echo "  -t, --time SECONDS         Set time difference threshold (default: ${BLOCK_HEIGHT_TIME_THRESHOLD}s)"
    echo "  -o, --output FILE          Set output file (default: ${BLOCK_HEIGHT_DATA_FILE})"
    echo "  -v, --verbose              Enable verbose output"
    echo "  -b, --background           Run in background mode"
    echo "  status                     Show current block height status"
    echo "  stop                       Stop background monitor"
    echo ""
}

# ÂèÇÊï∞Ëß£Êûê
parse_args() {
    while [[ $# -gt 0 ]]; do
        case $1 in
            -h|--help)
                show_help
                exit 0
                ;;
            -r|--rate)
                BLOCK_HEIGHT_MONITOR_RATE="$2"
                shift 2
                ;;
            --diff)
                BLOCK_HEIGHT_DIFF_THRESHOLD="$2"
                shift 2
                ;;
            -t|--time)
                BLOCK_HEIGHT_TIME_THRESHOLD="$2"
                shift 2
                ;;
            -o|--output)
                BLOCK_HEIGHT_DATA_FILE="$2"
                shift 2
                ;;
            -v|--verbose)
                VERBOSE=true
                shift
                ;;
            -b|--background)
                BACKGROUND=true
                shift
                ;;
            status)
                show_status
                exit 0
                ;;
            stop)
                stop_monitor
                exit 0
                ;;
            *)
                echo "Unknown option: $1"
                show_help
                exit 1
                ;;
        esac
    done
}

# Ê£ÄÊü•‰æùËµñ
check_dependencies() {
    if ! command -v curl &> /dev/null; then
        echo "Error: curl is not installed"
        exit 1
    fi
    if ! command -v jq &> /dev/null; then
        echo "Error: jq is not installed"
        exit 1
    fi
}

# Ëé∑ÂèñÊú¨Âú∞ËäÇÁÇπÂå∫ÂùóÈ´òÂ∫¶
get_local_block_height() {
    # ‰ΩøÁî®ÂÖ±‰∫´ÂáΩÊï∞Â∫ì‰∏≠ÁöÑÂáΩÊï∞Ëé∑ÂèñÂå∫ÂùóÈ´òÂ∫¶
    source "$(dirname "${BASH_SOURCE[0]}")/../core/common_functions.sh" && get_block_height "$LOCAL_RPC_URL"
}

# Ëé∑Âèñ‰∏ªÁΩëÂå∫ÂùóÈ´òÂ∫¶
get_mainnet_block_height() {
    # ‰ΩøÁî®ÂÖ±‰∫´ÂáΩÊï∞Â∫ì‰∏≠ÁöÑÂáΩÊï∞Ëé∑ÂèñÂå∫ÂùóÈ´òÂ∫¶
    source "$(dirname "${BASH_SOURCE[0]}")/../core/common_functions.sh" && get_block_height "$MAINNET_RPC_URL"
}

# Ê£ÄÊü•ËäÇÁÇπÂÅ•Â∫∑Áä∂ÊÄÅ
check_node_health() {
    local rpc_url=$1
    # ‰ΩøÁî®ÂÖ±‰∫´ÂáΩÊï∞Â∫ì‰∏≠ÁöÑÂáΩÊï∞Ê£ÄÊü•ÂÅ•Â∫∑Áä∂ÊÄÅ
    source "$(dirname "${BASH_SOURCE[0]}")/../core/common_functions.sh" && check_node_health "$rpc_url"
}

# ÁõëÊéßÂå∫ÂùóÈ´òÂ∫¶Â∑ÆÂºÇ
monitor_block_height_diff() {
    local timestamp=$(get_unified_timestamp)
    
    # ‰ΩøÁî®ÂÖ±‰∫´ÂáΩÊï∞Â∫ì‰∏≠ÁöÑÂáΩÊï∞Ëé∑ÂèñÂå∫ÂùóÈ´òÂ∫¶Êï∞ÊçÆ
    local block_height_data=$(source "$(dirname "${BASH_SOURCE[0]}")/../core/common_functions.sh" && get_cached_block_height_data "$BLOCK_HEIGHT_CACHE_FILE" 3 "$LOCAL_RPC_URL" "$MAINNET_RPC_URL")
    
    # Ëß£ÊûêÊï∞ÊçÆ
    local local_block_height=$(echo "$block_height_data" | jq -r '.local_block_height')
    local mainnet_block_height=$(echo "$block_height_data" | jq -r '.mainnet_block_height')
    local block_height_diff=$(echo "$block_height_data" | jq -r '.block_height_diff')
    local local_health=$(echo "$block_height_data" | jq -r '.local_health')
    local mainnet_health=$(echo "$block_height_data" | jq -r '.mainnet_health')
    local data_loss=$(echo "$block_height_data" | jq -r '.data_loss')
    
    # ‰ΩøÁî®ÁºìÂÜ≤ÂÜôÂÖ•ÂáèÂ∞ëÁ£ÅÁõò I/O
    local data_line="$timestamp,$local_block_height,$mainnet_block_height,$block_height_diff,$local_health,$mainnet_health,$data_loss"
    source "$(dirname "${BASH_SOURCE[0]}")/../core/common_functions.sh" && buffered_write "$BLOCK_HEIGHT_DATA_FILE" "$data_line" 10
    
    # Ê£ÄÊü•Âå∫ÂùóÈ´òÂ∫¶Â∑ÆÂºÇÊòØÂê¶Ë∂ÖËøáÈòàÂÄº
    if [[ "$block_height_diff" != "null" && "$block_height_diff" != "N/A" && $block_height_diff -gt $BLOCK_HEIGHT_DIFF_THRESHOLD ]]; then
        if [[ "$BLOCK_HEIGHT_DIFF_ALERT" == "false" ]]; then
            BLOCK_HEIGHT_DIFF_ALERT=true
            BLOCK_HEIGHT_DIFF_START_TIME=$(get_unified_timestamp)
            echo "‚ö†Ô∏è ALERT: Block height difference ($block_height_diff) exceeds threshold ($BLOCK_HEIGHT_DIFF_THRESHOLD) at $BLOCK_HEIGHT_DIFF_START_TIME"
            
            # ËÆ∞ÂΩïÂºÇÂ∏∏‰∫ã‰ª∂ÂºÄÂßã
            BLOCK_HEIGHT_DIFF_EVENT_ID=$(./unified_event_manager.sh start "block_height_diff" "block_height_monitor" "Block height difference $block_height_diff exceeds threshold $BLOCK_HEIGHT_DIFF_THRESHOLD")
        fi
        
        # Ê£ÄÊü•ÊåÅÁª≠Êó∂Èó¥ÊòØÂê¶Ë∂ÖËøáÈòàÂÄº
        if [[ -n "$BLOCK_HEIGHT_DIFF_START_TIME" ]]; then
            local start_seconds=$(date -d "$BLOCK_HEIGHT_DIFF_START_TIME" +%s)
            local current_seconds=$(date +%s)
            local duration=$((current_seconds - start_seconds))
            
            if [[ $duration -gt $BLOCK_HEIGHT_TIME_THRESHOLD ]]; then
                echo "üö® CRITICAL: Block height difference has exceeded threshold for ${duration}s (> ${BLOCK_HEIGHT_TIME_THRESHOLD}s)"
                echo "üö® CRITICAL: Local node may be considered unavailable for service"
                
                # ËÆæÁΩÆÊåÅÁª≠Ë∂ÖÈôêÊ†áÂøóÊñá‰ª∂ÔºàÁî®‰∫éÁ≥ªÁªüÁ∫ßÁì∂È¢àÂà§Êñ≠Ôºâ
                echo "1" > "${MEMORY_SHARE_DIR}/block_height_time_exceeded.flag"
                
                # ËÆ∞ÂΩï‰∫ã‰ª∂
                BLOCK_HEIGHT_DIFF_EVENTS+=("CRITICAL: Block height diff $block_height_diff for ${duration}s at $(get_unified_timestamp)")
            fi
        fi
    elif [[ "$BLOCK_HEIGHT_DIFF_ALERT" == "true" ]]; then
        BLOCK_HEIGHT_DIFF_ALERT=false
        BLOCK_HEIGHT_DIFF_END_TIME=$(get_unified_timestamp)
        
        # ËÆ°ÁÆóÊåÅÁª≠Êó∂Èó¥
        local start_seconds=$(date -d "$BLOCK_HEIGHT_DIFF_START_TIME" +%s)
        local end_seconds=$(date -d "$BLOCK_HEIGHT_DIFF_END_TIME" +%s)
        local duration=$((end_seconds - start_seconds))
        
        echo "‚úÖ RESOLVED: Block height difference is now below threshold at $BLOCK_HEIGHT_DIFF_END_TIME (lasted ${duration}s)"
        
        # ËÆ∞ÂΩï‰∫ã‰ª∂ÁªìÊùü
        if [[ -n "$BLOCK_HEIGHT_DIFF_EVENT_ID" ]]; then
            ./unified_event_manager.sh end "$BLOCK_HEIGHT_DIFF_EVENT_ID"
        fi
        
        # ËÆ∞ÂΩï‰∫ã‰ª∂
        BLOCK_HEIGHT_DIFF_EVENTS+=("RESOLVED: Block height diff normalized after ${duration}s at $BLOCK_HEIGHT_DIFF_END_TIME")
        
        # ÈáçÁΩÆÂºÄÂßãÊó∂Èó¥
        BLOCK_HEIGHT_DIFF_START_TIME=""
        BLOCK_HEIGHT_DIFF_EVENT_ID=""
    fi
    
    # Ê£ÄÊü•Êï∞ÊçÆ‰∏¢Â§±
    if [[ "$data_loss" == "1" ]]; then
        DATA_LOSS_COUNT=$((DATA_LOSS_COUNT + 1))
        
        if [[ "$DATA_LOSS_ALERT" == "false" ]]; then
            DATA_LOSS_ALERT=true
            DATA_LOSS_START_TIME=$(get_unified_timestamp)
            DATA_LOSS_PERIODS=$((DATA_LOSS_PERIODS + 1))
            # ËΩ¨Êç¢Êï∞ÂÄº‰∏∫‰∫∫Á±ªÂèØËØªÊ†ºÂºè
            local local_health_display=$([ "$local_health" = "1" ] && echo "healthy" || echo "unhealthy")
            local mainnet_health_display=$([ "$mainnet_health" = "1" ] && echo "healthy" || echo "unhealthy")
            
            echo "‚ö†Ô∏è ALERT: Data loss or node health issue detected at $DATA_LOSS_START_TIME"
            echo "    Local health: $local_health_display, Mainnet health: $mainnet_health_display"
            echo "    Local block height: $local_block_height, Mainnet block height: $mainnet_block_height"
            
            # ËÆ∞ÂΩïÊï∞ÊçÆ‰∏¢Â§±ÁªüËÆ°Âà∞ÂÖ±‰∫´Êñá‰ª∂
            update_data_loss_stats
        fi
    elif [[ "$DATA_LOSS_ALERT" == "true" ]]; then
        DATA_LOSS_ALERT=false
        DATA_LOSS_END_TIME=$(get_unified_timestamp)
        
        # ËÆ°ÁÆóÊåÅÁª≠Êó∂Èó¥
        local start_seconds=$(date -d "$DATA_LOSS_START_TIME" +%s)
        local end_seconds=$(date -d "$DATA_LOSS_END_TIME" +%s)
        local duration=$((end_seconds - start_seconds))
        
        DATA_LOSS_TOTAL_DURATION=$((DATA_LOSS_TOTAL_DURATION + duration))
        
        echo "‚úÖ RESOLVED: Data loss or node health issue resolved at $DATA_LOSS_END_TIME (lasted ${duration}s)"
        
        # ËÆ∞ÂΩï‰∫ã‰ª∂
        DATA_LOSS_EVENTS+=("Data loss or node health issue for ${duration}s from $DATA_LOSS_START_TIME to $DATA_LOSS_END_TIME")
        
        # Êõ¥Êñ∞ÁªüËÆ°
        update_data_loss_stats
        
        # ÈáçÁΩÆÂºÄÂßãÊó∂Èó¥
        DATA_LOSS_START_TIME=""
    fi
    
    # ËØ¶ÁªÜËæìÂá∫
    if [[ "$VERBOSE" == "true" ]]; then
        # ËΩ¨Êç¢Êï∞ÂÄº‰∏∫‰∫∫Á±ªÂèØËØªÊ†ºÂºè
        local local_health_display=$([ "$local_health" = "1" ] && echo "healthy" || echo "unhealthy")
        local mainnet_health_display=$([ "$mainnet_health" = "1" ] && echo "healthy" || echo "unhealthy")
        local data_loss_display=$([ "$data_loss" = "1" ] && echo "detected" || echo "none")
        echo "[$timestamp] Local: $local_block_height, Mainnet: $mainnet_block_height, Diff: $block_height_diff, Local Health: $local_health_display, Mainnet Health: $mainnet_health_display, Data Loss: $data_loss_display"
    fi
    
    # Ê∏ÖÁêÜÊóßÁöÑÁºìÂ≠òÊï∞ÊçÆ
    source "$(dirname "${BASH_SOURCE[0]}")/../core/common_functions.sh" && cleanup_block_height_cache "$MEMORY_SHARE_DIR" 5
}

# ÊòæÁ§∫ÂΩìÂâçÁä∂ÊÄÅ
show_status() {
    echo "Block Height Monitor Status"
    echo "===================="
    
    # Ëé∑ÂèñÊúÄÊñ∞ÁöÑÂå∫ÂùóÈ´òÂ∫¶Êï∞ÊçÆ
    local block_height_data=$(source "$(dirname "${BASH_SOURCE[0]}")/../core/common_functions.sh" && get_cached_block_height_data "$BLOCK_HEIGHT_CACHE_FILE" "$CACHE_MAX_AGE" "$LOCAL_RPC_URL" "$MAINNET_RPC_URL")
    
    # Ëß£ÊûêÊï∞ÊçÆ
    local timestamp=$(echo "$block_height_data" | jq -r '.timestamp')
    local local_block_height=$(echo "$block_height_data" | jq -r '.local_block_height')
    local mainnet_block_height=$(echo "$block_height_data" | jq -r '.mainnet_block_height')
    local block_height_diff=$(echo "$block_height_data" | jq -r '.block_height_diff')
    local local_health=$(echo "$block_height_data" | jq -r '.local_health')
    local mainnet_health=$(echo "$block_height_data" | jq -r '.mainnet_health')
    local data_loss=$(echo "$block_height_data" | jq -r '.data_loss')
    
    # ËΩ¨Êç¢Êï∞ÂÄº‰∏∫‰∫∫Á±ªÂèØËØªÊ†ºÂºè
    local local_health_display=$([ "$local_health" = "1" ] && echo "healthy" || echo "unhealthy")
    local mainnet_health_display=$([ "$mainnet_health" = "1" ] && echo "healthy" || echo "unhealthy")
    local data_loss_display=$([ "$data_loss" = "1" ] && echo "detected" || echo "none")
    
    echo "Last update: $timestamp"
    echo "Local block height: $local_block_height"
    echo "Mainnet block height: $mainnet_block_height"
    echo "Block height difference: $block_height_diff"
    echo "Local health: $local_health_display"
    echo "Mainnet health: $mainnet_health_display"
    echo "Data loss: $data_loss_display"
    
    # Ê£ÄÊü•ÊòØÂê¶Ë∂ÖËøáÈòàÂÄº
    if [[ "$block_height_diff" != "null" && $block_height_diff -gt $BLOCK_HEIGHT_DIFF_THRESHOLD ]]; then
        echo "‚ö†Ô∏è WARNING: Block height difference exceeds threshold ($BLOCK_HEIGHT_DIFF_THRESHOLD)"
    else
        echo "‚úÖ OK: Block height difference is within threshold"
    fi
    
    # Ê£ÄÊü•ÊòØÂê¶ÊúâËøõÁ®ãÂú®ËøêË°å
    if [[ -f "${TMP_DIR}/block_height_monitor.pid" ]]; then
        local pid=$(cat "${TMP_DIR}/block_height_monitor.pid")
        if kill -0 "$pid" 2>/dev/null; then
            echo "Monitor is running with PID: $pid"
        else
            echo "Monitor is not running (stale PID file)"
        fi
    else
        echo "Monitor is not running"
    fi
}

# ÂÅúÊ≠¢ÁõëÊéß
stop_monitor() {
    echo "Stopping block height monitor..."
    
    if [[ -f "${TMP_DIR}/block_height_monitor.pid" ]]; then
        local pid=$(cat "${TMP_DIR}/block_height_monitor.pid" 2>/dev/null)
        if [[ -n "$pid" ]] && kill -0 "$pid" 2>/dev/null; then
            echo "Stopping Block height monitor (PID: $pid)..."
            kill "$pid" 2>/dev/null
            sleep 2
            
            # Ê£ÄÊü•ËøõÁ®ãÊòØÂê¶ËøòÂú®ËøêË°å
            if kill -0 "$pid" 2>/dev/null; then
                echo "Force killing Block height monitor (PID: $pid)..."
                kill -9 "$pid" 2>/dev/null
            fi
            
            echo "Block height monitor stopped successfully"
        else
            echo "Block height monitor is not running"
        fi
        rm -f "${TMP_DIR}/block_height_monitor.pid"
    else
        echo "Block height monitor PID file not found"
        # Â∞ùËØïÈÄöËøáËøõÁ®ãÂêçÁªàÊ≠¢
        pkill -f "block_height_monitor.sh" 2>/dev/null || true
    fi
    
    # Ê∏ÖÁêÜÁºìÂÜ≤Êñá‰ª∂
    if [[ -n "$BLOCK_HEIGHT_DATA_FILE" ]]; then
        rm -f "${BLOCK_HEIGHT_DATA_FILE}.buffer" 2>/dev/null || true
    fi
    
    # Ê∏ÖÁêÜÂÖ±‰∫´ÂÜÖÂ≠ò
    rm -rf /dev/shm/blockchain-node-qps-test/ 2>/dev/null || true
    
    echo "Block height monitor cleanup completed"
}

# ÂêØÂä®ÁõëÊéß
start_monitoring() {
    echo "Starting Block Height monitor..."
    echo "Monitoring rate: ${BLOCK_HEIGHT_MONITOR_RATE}/s"
    echo "Block height difference threshold: ${BLOCK_HEIGHT_DIFF_THRESHOLD}"
    echo "Block height time difference threshold: ${BLOCK_HEIGHT_TIME_THRESHOLD}s"
    echo "Output file: $BLOCK_HEIGHT_DATA_FILE"
    
    # ÂàõÂª∫ËæìÂá∫ÁõÆÂΩï
    mkdir -p "$(dirname "$BLOCK_HEIGHT_DATA_FILE")"
    
    # ÂàõÂª∫ÁºìÂ≠òÁõÆÂΩï
    if [[ "$USE_MEMORY_CACHE" == "true" ]]; then
        mkdir -p "$(dirname "$BLOCK_HEIGHT_CACHE_FILE")"
    fi
    
    # ÂÜôÂÖ• CSV Â§¥
    echo "timestamp,local_block_height,mainnet_block_height,block_height_diff,local_health,mainnet_health,data_loss" > "$BLOCK_HEIGHT_DATA_FILE"
    
    # Áªü‰∏ÄÁöÑÁõëÊéßÂæ™ÁéØ - Ë∑üÈöèÊ°ÜÊû∂ÁîüÂëΩÂë®Êúü
    if [[ "$BACKGROUND" == "true" ]]; then
        (
            # Âú®ÂêéÂè∞ËøõÁ®ã‰∏≠ËÆæÁΩÆ‰ø°Âè∑Â§ÑÁêÜ
            trap 'cleanup_and_exit' SIGTERM SIGINT SIGQUIT EXIT
            
            # È¢ëÁéáËΩ¨Êç¢ÔºöËÆ°ÁÆósleepÈó¥Èöî
            local sleep_interval=$(awk "BEGIN {printf \"%.3f\", 1/$BLOCK_HEIGHT_MONITOR_RATE}" 2>/dev/null || echo "1")
            
            # Ë∑üÈöèÊ°ÜÊû∂ÁîüÂëΩÂë®Êúü
            while [[ -f "$TMP_DIR/qps_test_status" ]]; do
                monitor_block_height_diff
                sleep "$sleep_interval"
            done
        ) &
        MONITOR_PID=$!
        echo "Monitor started in background with PID: $MONITOR_PID"
        echo "$MONITOR_PID" > "${TMP_DIR}/block_height_monitor.pid"
    else
        # ÂâçÂè∞Ê®°ÂºèÔºà‰øùÁïôÁî®‰∫éË∞ÉËØïÔºâ
        trap 'cleanup_and_exit' SIGTERM SIGINT SIGQUIT
        
        # È¢ëÁéáËΩ¨Êç¢ÔºöËÆ°ÁÆósleepÈó¥Èöî
        local sleep_interval=$(awk "BEGIN {printf \"%.3f\", 1/$BLOCK_HEIGHT_MONITOR_RATE}" 2>/dev/null || echo "1")
        
        # Ë∑üÈöèÊ°ÜÊû∂ÁîüÂëΩÂë®Êúü
        while [[ -f "$TMP_DIR/qps_test_status" ]]; do
            monitor_block_height_diff
            sleep "$sleep_interval"
        done
    fi
}

# ‰∏ªÂáΩÊï∞
main() {
    # Ê£ÄÊü•‰æùËµñ
    check_dependencies
    
    # Ëß£ÊûêÂèÇÊï∞
    parse_args "$@"
    
    # ÂêØÂä®ÁõëÊéß
    start_monitoring
}

# ÊâßË°å‰∏ªÂáΩÊï∞
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    main "$@"
fi
# Êõ¥Êñ∞Êï∞ÊçÆ‰∏¢Â§±ÁªüËÆ°
update_data_loss_stats() {
    # ÂàõÂª∫Áªü‰∏ÄÁöÑÊï∞ÊçÆ‰∏¢Â§±ÁªüËÆ°JSON
    local stats_json="{
        \"data_loss_count\": $DATA_LOSS_COUNT,
        \"data_loss_periods\": $DATA_LOSS_PERIODS,
        \"total_duration\": $DATA_LOSS_TOTAL_DURATION,
        \"last_updated\": \"$(date +"%Y-%m-%d %H:%M:%S")\"
    }"
    
    # ÂÜôÂÖ•ÂÖ±‰∫´Êñá‰ª∂
    echo "$stats_json" > "${MEMORY_SHARE_DIR}/data_loss_stats.json"
}
